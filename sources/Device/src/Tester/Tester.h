#pragma once
#include "defines.h"
#include "Settings/SettingsChannel.h"


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#define TESTER_NUM_POINTS               (240)
#define TESTER_CONTROL                  (set.test_control)
#define TESTER_CONTROL_IS_U             (TESTER_CONTROL == Tester::Control::Voltage)
#define TESTER_POLARITY                 (set.test_polarity)
#define TESTER_POLARITY_IS_POSITITVE    (TESTER_POLARITY == Tester::Polarity::Positive)



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class Tester
{
public:
    static void Init();

    static void Enable();

    static void Disable();

    static void Update();

    static void ProcessStep();
    /// Загружает полярность из Settings
    static void LoadPolarity();
    /// Устанавливает шаг изменения напряжения в соотвествии с настройками Settings
    static void LoadStep();

private:
    /// Загрузить FPGA в соответствии с установленными настройками
    static void LoadFPGA();
    /// Считать данные очередной ступеньки
    static void ReadData();
    /// Запустить процесс чтения очередной ступеньки
    static void StartFPGA();
    /// Текущий шаг
    static int step;
    /// Шаг изменения напряжения
    static float stepU;

public:
    /// Чем будем управлять в тестер-компоненте - напряжением или током
    struct Control
    {
        enum E
        {
            Voltage,
            Current
        } value;
        operator uint8() const { return (uint8)value; };
    };

    struct Polarity
    {
        enum E
        {
            Positive,
            Negative
        } value;
        operator uint8() const { return (uint8)value; };
    };

    struct StepU
    {
        enum E
        {
            _100mV,
            _500mV
        } value;
        operator uint8() const { return (uint8)value; };
    };

    struct StepI
    {
        enum E
        {
            _4mA,
            _20mA
        } value;
        operator uint8() const { return (uint8)value; };
    };
};

#define NUM_STEPS       5

extern uint8 dataTester[Chan::Number][NUM_STEPS][TESTER_NUM_POINTS];
